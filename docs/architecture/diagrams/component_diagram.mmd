graph TB
    %% Ê†∑ÂºèÂÆö‰πâ
    classDef component fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef interface fill:#fff8e1,stroke:#ff8f00,stroke-width:2px
    classDef data fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef external fill:#ffebee,stroke:#c62828,stroke-width:2px

    %% HTTP Server ÁªÑ‰ª∂
    subgraph HTTPServer["üì° HTTP Server ÁªÑ‰ª∂"]
        Router["Router\nË∑ØÁî±ÂàÜÂèë"]
        ChatHandler["ChatHandler\nÂ§ÑÁêÜËÅäÂ§©ËØ∑Ê±Ç"]
        StreamHandler["StreamHandler\nSSEÊµÅÂºèÂìçÂ∫î"]
        HistoryHandler["HistoryHandler\nÂéÜÂè≤ËÆ∞ÂΩïÊü•ËØ¢"]
        ConfigHandler["ConfigHandler\nÈÖçÁΩÆÊü•ËØ¢"]
        HealthHandler["HealthHandler\nÂÅ•Â∫∑Ê£ÄÊü•"]
        StopHandler["StopHandler\nÂÅúÊ≠¢ÁîüÊàê"]
    end

    %% Gateway ÁªÑ‰ª∂
    subgraph GatewayComp["üåê Gateway ÁªÑ‰ª∂"]
        WSServer["WebSocket Server\nÁõëÂê¨ËøûÊé•"]
        ConnectionPool["ConnectionPool\nËøûÊé•Ê±†ÁÆ°ÁêÜ"]
        SessionManager["SessionManager\n‰ºöËØùÁÆ°ÁêÜ"]
        MessageRouter["MessageRouter\nÊ∂àÊÅØË∑ØÁî±"]
        ProtocolHandler["ProtocolHandler\nÂçèËÆÆÂ§ÑÁêÜ"]
    end

    %% Agent Runner ÁªÑ‰ª∂
    subgraph AgentComp["ü§ñ Agent Runner ÁªÑ‰ª∂"]
        EventConsumer["EventConsumer\n‰∫ã‰ª∂Ê∂àË¥πËÄÖ"]
        ContextBuilder["ContextBuilder\n‰∏ä‰∏ãÊñáÊûÑÂª∫"]
        LLMCaller["LLMCaller\nLLMË∞ÉÁî®Âô®"]
        ToolExecutor["ToolExecutor\nÂ∑•ÂÖ∑ÊâßË°åÂô®"]
        ResponseFormatter["ResponseFormatter\nÂìçÂ∫îÊ†ºÂºèÂåñ"]
    end

    %% LLM Provider ÁªÑ‰ª∂
    subgraph LLMComp["üß† LLM Provider ÁªÑ‰ª∂"]
        ProviderTrait["LLMProvider Trait\nProviderÊé•Âè£"]
        OpenAIProvider["OpenAIProvider\nOpenAIÂÖºÂÆπ"]
        CopilotProvider["CopilotProvider\nGitHub Copilot"]
        ForwardProvider["ForwardProvider\nËΩ¨ÂèëProvider"]
        AuthManager["AuthManager\nËÆ§ËØÅÁÆ°ÁêÜ"]
        SchemaTransformer["SchemaTransformer\nSchemaËΩ¨Êç¢"]
    end

    %% Storage ÁªÑ‰ª∂
    subgraph StorageComp["üíæ Storage ÁªÑ‰ª∂"]
        StorageTrait["Storage Trait\nÂ≠òÂÇ®Êé•Âè£"]
        JsonlImpl["JsonlStorage\nJSONLÂÆûÁé∞"]
        SessionStore["SessionStore\n‰ºöËØùÂ≠òÂÇ®"]
        EventStore["EventStore\n‰∫ã‰ª∂Â≠òÂÇ®"]
        IndexManager["IndexManager\nÁ¥¢ÂºïÁÆ°ÁêÜ"]
    end

    %% Skill System ÁªÑ‰ª∂
    subgraph SkillComp["üéØ Skill System ÁªÑ‰ª∂"]
        SkillManager["SkillManager\nSkillÁÆ°ÁêÜ"]
        SkillParser["SkillParser\nSKILL.mdËß£Êûê"]
        SkillWatcher["SkillWatcher\nÊñá‰ª∂ÁõëÂê¨"]
        ToolRegistry["ToolRegistry\nÂ∑•ÂÖ∑Ê≥®ÂÜåË°®"]
        HotReloader["HotReloader\nÁÉ≠ÈáçËΩΩ"]
    end

    %% Êï∞ÊçÆÊµÅ
    Router -->|/chat| ChatHandler
    Router -->|/stream| StreamHandler
    Router -->|/history| HistoryHandler
    Router -->|/config| ConfigHandler
    Router -->|/health| HealthHandler
    Router -->|/stop| StopHandler

    ChatHandler -->|ÂàõÂª∫‰ºöËØù| SessionManager
    StreamHandler -->|ËÆ¢ÈòÖ‰∫ã‰ª∂| EventConsumer
    
    WSServer -->|Êé•ÂèóËøûÊé•| ConnectionPool
    ConnectionPool -->|ÁÆ°ÁêÜ| SessionManager
    SessionManager -->|Ë∑ØÁî±| MessageRouter
    MessageRouter -->|Â§ÑÁêÜ| ProtocolHandler
    ProtocolHandler -->|ÂèëÂ∏É| EventConsumer

    EventConsumer -->|ÊûÑÂª∫| ContextBuilder
    ContextBuilder -->|Ë∞ÉÁî®| LLMCaller
    LLMCaller -->|‰ΩøÁî®| ProviderTrait
    ProviderTrait -->|OpenAI| OpenAIProvider
    ProviderTrait -->|Copilot| CopilotProvider
    ProviderTrait -->|Forward| ForwardProvider
    
    LLMCaller -->|ÈúÄË¶ÅÂ∑•ÂÖ∑| ToolExecutor
    ToolExecutor -->|Êü•ËØ¢| ToolRegistry
    ToolRegistry -->|Âä†ËΩΩ| SkillManager
    SkillManager -->|Ëß£Êûê| SkillParser
    SkillManager -->|ÁõëÂê¨| SkillWatcher
    SkillWatcher -->|ÁÉ≠ÈáçËΩΩ| HotReloader

    LLMCaller -->|ËÆ§ËØÅ| AuthManager
    AuthManager -->|ËΩ¨Êç¢| SchemaTransformer

    SessionManager -->|Â≠òÂÇ®| StorageTrait
    StorageTrait -->|ÂÆûÁé∞| JsonlImpl
    JsonlImpl -->|‰ºöËØù| SessionStore
    JsonlImpl -->|‰∫ã‰ª∂| EventStore
    JsonlImpl -->|Á¥¢Âºï| IndexManager

    ResponseFormatter -->|SSE| StreamHandler
    ResponseFormatter -->|WebSocket| ProtocolHandler

    %% Â§ñÈÉ®Êé•Âè£
    OpenAIProvider -->|HTTP| ExternalOpenAI["OpenAI API"]
    CopilotProvider -->|HTTP| ExternalCopilot["GitHub Copilot"]

    %% Ê†∑ÂºèÂ∫îÁî®
    class Router,ChatHandler,StreamHandler,HistoryHandler,ConfigHandler,HealthHandler,StopHandler component
    class WSServer,ConnectionPool,SessionManager,MessageRouter,ProtocolHandler component
    class EventConsumer,ContextBuilder,LLMCaller,ToolExecutor,ResponseFormatter component
    class ProviderTrait,OpenAIProvider,CopilotProvider,ForwardProvider,AuthManager,SchemaTransformer component
    class StorageTrait,JsonlImpl,SessionStore,EventStore,IndexManager component
    class SkillManager,SkillParser,SkillWatcher,ToolRegistry,HotReloader component
    class ExternalOpenAI,ExternalCopilot external
