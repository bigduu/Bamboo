graph TB
    %% æ ·å¼å®šä¹‰
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef service fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef core fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef capability fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef external fill:#ffebee,stroke:#b71c1c,stroke-width:2px
    classDef storage fill:#fffde7,stroke:#f57f17,stroke-width:2px

    %% å®¢æˆ·ç«¯å±‚
    subgraph Client["ğŸ–¥ï¸ å®¢æˆ·ç«¯å±‚"]
        CLI["bamboo-cli\nå‘½ä»¤è¡Œå®¢æˆ·ç«¯"]
        TUI["bamboo-tui\nç»ˆç«¯UIå®¢æˆ·ç«¯"]
        Web["Webå®¢æˆ·ç«¯\n(æµè§ˆå™¨/æ‰©å±•)"]
    end

    %% æœåŠ¡å±‚
    subgraph Service["âš™ï¸ æœåŠ¡å±‚"]
        Server["bamboo-server\nHTTP/WebSocketæœåŠ¡"]
        Gateway["Gateway\nWebSocketç½‘å…³"]
        AgentRunner["AgentRunner\nAgentæ‰§è¡Œå™¨"]
        EventBus["EventBus\näº‹ä»¶æ€»çº¿"]
        Handlers["HTTP Handlers\nREST APIç«¯ç‚¹"]
    end

    %% æ ¸å¿ƒå±‚
    subgraph Core["ğŸ”§ æ ¸å¿ƒå±‚"]
        BambooCore["bamboo-core\næ ¸å¿ƒç±»å‹ä¸Agentå¾ªç¯"]
        Session["bamboo-session\nä¼šè¯å­˜å‚¨ç®¡ç†"]
        Config["bamboo-config\né…ç½®ç®¡ç†"]
    end

    %% èƒ½åŠ›å±‚
    subgraph Capability["ğŸ› ï¸ èƒ½åŠ›å±‚"]
        LLM["bamboo-llm\nLLM Provider"]
        Skill["bamboo-skill\nSkillç®¡ç†"]
        Tool["bamboo-tool\nå·¥å…·æ‰§è¡Œ"]
        MCP["bamboo-mcp\nMCPå®¢æˆ·ç«¯"]
    end

    %% å¤–éƒ¨æœåŠ¡
    subgraph External["ğŸŒ å¤–éƒ¨æœåŠ¡"]
        OpenAI["OpenAI API"]
        Copilot["GitHub Copilot"]
        LocalLLM["æœ¬åœ°LLM\n(Ollamaç­‰)"]
    end

    %% å­˜å‚¨å±‚
    subgraph Storage["ğŸ’¾ å­˜å‚¨å±‚"]
        JsonlStorage["JsonlStorage\nJSONLæ–‡ä»¶å­˜å‚¨"]
        ConfigFile["config.json\né…ç½®æ–‡ä»¶"]
        SessionData["Sessionæ•°æ®\n(~/.bamboo/sessions)"]
        SkillDir["Skillç›®å½•\n(~/.bamboo/skills)"]
    end

    %% è¿æ¥å…³ç³»
    CLI -->|HTTP POST /api/v1/chat| Handlers
    TUI -->|HTTP SSE /api/v1/stream| Handlers
    Web -->|WebSocket ws://| Gateway

    Handlers -->|ä½¿ç”¨| Server
    Server -->|å‘å¸ƒäº‹ä»¶| EventBus
    Gateway -->|æ¶ˆæ¯è½¬å‘| EventBus
    EventBus -->|æ¶ˆè´¹| AgentRunner

    Server -->|ç®¡ç†| BambooCore
    Server -->|è¯»å–| Config
    AgentRunner -->|è°ƒç”¨| LLM
    AgentRunner -->|æ‰§è¡Œ| Tool

    Skill -->|å®šä¹‰| Tool
    MCP -->|å®ç°| Tool
    Tool -->|æ¥å£| BambooCore

    LLM -->|OpenAI API| OpenAI
    LLM -->|Copilot API| Copilot
    LLM -->|Local API| LocalLLM

    BambooCore -->|å­˜å‚¨| Session
    Session -->|JsonlStorage| JsonlStorage
    SessionData -->|åŠ è½½| Session

    Config -->|åŠ è½½| ConfigFile
    Skill -->|æ‰«æ| SkillDir

    %% æ ·å¼åº”ç”¨
    class CLI,TUI,Web client
    class Server,Gateway,AgentRunner,EventBus,Handlers service
    class BambooCore,Session,Config core
    class LLM,Skill,Tool,MCP capability
    class OpenAI,Copilot,LocalLLM external
    class JsonlStorage,ConfigFile,SessionData,SkillDir storage
