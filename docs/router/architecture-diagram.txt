┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              BAMBOO MESSAGE ROUTER SYSTEM                               │
│                                     架构总览                                             │
└─────────────────────────────────────────────────────────────────────────────────────────┘

                                    ┌─────────────┐
                                    │   Client    │
                                    │  (Web/App)  │
                                    └──────┬──────┘
                                           │
                                           │ WebSocket
                                           │ JSON
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    GATEWAY LAYER                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                      GatewayIntegration                                         │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐  │   │
│  │  │ WebSocket   │───►│  Message    │───►│   publish   │───►│  gateway:input  │  │   │
│  │  │  Receiver   │    │   Parser    │    │   to Bus    │    │                 │  │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────────┘  │   │
│  │                                                                                 │   │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────────┐  │   │
│  │  │gateway:     │───►│  Message    │───►│  WebSocket  │───►│     Client      │  │   │
│  │  │output:{id}  │    │  Serializer │    │   Sender    │    │                 │  │   │
│  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           │ publish / subscribe
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   MESSAGE BUS (Core)                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                                                                 │   │
│  │    ┌──────────────────────────────────────────────────────────────────┐        │   │
│  │    │  MessageBus                                                      │        │   │
│  │    │  ┌────────────────────────────────────────────────────────────┐  │        │   │
│  │    │  │  channels: DashMap<String, mpsc::Sender<Message>>          │  │        │   │
│  │    │  │                                                              │  │        │   │
│  │    │  │  ┌──────────────────┐  ┌──────────────────┐               │  │        │   │
│  │    │  │  │  "gateway:input" │  │  "agent:input"   │  ...          │  │        │   │
│  │    │  │  │  ──────────────  │  │  ──────────────  │               │  │        │   │
│  │    │  │  │  Sender<Message> │  │  Sender<Message> │               │  │        │   │
│  │    │  │  └──────────────────┘  └──────────────────┘               │  │        │   │
│  │    │  └────────────────────────────────────────────────────────────┘  │        │   │
│  │    │                                                                 │        │   │
│  │    │  Methods:                                                       │        │   │
│  │    │    • publish(topic, msg)  -> Result<()>                        │        │   │
│  │    │    • subscribe(topic)     -> mpsc::Receiver<Message>           │        │   │
│  │    │    • try_publish(topic, msg) -> Result<()>                     │        │   │
│  │    │    • broadcast(topics, msg) -> Vec<Result<()>>                 │        │   │
│  │    └──────────────────────────────────────────────────────────────────┘        │   │
│  │                                                                                 │   │
│  │  TOPICS:                                                                        │   │
│  │    • gateway:input       - 来自客户端的输入                                    │   │
│  │    • gateway:output:{id} - 发送给特定客户端                                    │   │
│  │    • agent:input         - Agent Loop 输入                                     │   │
│  │    • agent:output        - Agent Loop 输出                                     │   │
│  │    • command:input       - 命令处理器输入                                      │   │
│  │    • command:output      - 命令处理器输出                                      │   │
│  │    • system:input        - 系统处理器输入                                      │   │
│  │    • system:output       - 系统处理器输出                                      │   │
│  │                                                                                 │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           │ subscribe
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ROUTER LAYER                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                         MessageRouter                                           │   │
│  │                                                                                 │   │
│  │   ┌─────────────────────────────────────────────────────────────────────────┐  │   │
│  │   │  Handlers: Vec<Box<dyn MessageHandler>>                                 │  │   │
│  │   │                                                                           │  │   │
│  │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐ │  │   │
│  │   │  │ ChatHandler │  │CommandHandler│  │SystemHandler│  │  CustomHandler  │ │  │   │
│  │   │  │   (Chat)    │  │  (Command)   │  │   (System)  │  │     (...)       │ │  │   │
│  │   │  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └────────┬────────┘ │  │   │
│  │   │         └─────────────────┴─────────────────┘                  │          │  │   │
│  │   │                           │                                    │          │  │   │
│  │   └───────────────────────────┼────────────────────────────────────┘          │  │   │
│  │                               │                                               │  │   │
│  │   ┌───────────────────────────▼─────────────────────────────────────────────┐ │  │   │
│  │   │                          route_incoming()                                │ │  │   │
│  │   │  1. 接收 gateway:input 消息                                              │ │  │   │
│  │   │  2. 查找匹配的 Handler (can_handle)                                      │ │  │   │
│  │   │  3. 调用 handler.handle(msg, bus)                                        │ │  │   │
│  │   │  4. 处理响应/错误                                                        │ │  │   │
│  │   └───────────────────────────┬─────────────────────────────────────────────┘ │  │   │
│  │                               │                                               │  │   │
│  │   ┌───────────────────────────▼─────────────────────────────────────────────┐ │  │   │
│  │   │                          route_response()                                │ │  │   │
│  │   │  1. 接收 agent:output/command:output/system:output                       │ │  │   │
│  │   │  2. 确定目标客户端                                                       │ │  │   │
│  │   │  3. 发布到 gateway:output:{client_id}                                    │ │  │   │
│  │   └──────────────────────────────────────────────────────────────────────────┘ │  │   │
│  │                                                                                │  │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           │ publish to
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                   HANDLER LAYER                                         │
│                                                                                         │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐                     │
│   │      ChatHandler            │  │      CommandHandler         │                     │
│   │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │                     │
│   │  │ Input: MessageKind::  │  │  │  │ Input: MessageKind::  │  │                     │
│   │  │        Chat           │  │  │  │        Command        │  │                     │
│   │  │                       │  │  │  │                       │  │                     │
│   │  │ Process:              │  │  │  │ Process:              │  │                     │
│   │  │ 1. Preprocess content │  │  │  │ 1. Parse command      │  │                     │
│   │  │ 2. Publish to         │  │  │  │ 2. Execute command    │  │                     │
│   │  │    agent:input        │  │  │  │ 3. Return response    │  │                     │
│   │  │ 3. Return None        │  │  │  │                       │  │                     │
│   │  │    (async process)    │  │  │  │ Commands:             │  │                     │
│   │  │                       │  │  │  │ • ping                │  │                     │
│   │  │ Output: None          │  │  │  │ • echo                │  │                     │
│   │  │ (Agent will respond)  │  │  │  │ • help                │  │                     │
│   │  └───────────────────────┘  │  │  │ • status              │  │                     │
│   │                             │  │  └───────────────────────┘  │                     │
│   └─────────────────────────────┘  └─────────────────────────────┘                     │
│                                                                                         │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐                     │
│   │      SystemHandler          │  │      SessionManager         │                     │
│   │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │                     │
│   │  │ Input: MessageKind::  │  │  │  │ Input: All messages   │  │                     │
│   │  │        System         │  │  │  │                       │  │                     │
│   │  │                       │  │  │  │ Process:              │  │                     │
│   │  │ Actions:              │  │  │  │ 1. Track sessions     │  │                     │
│   │  │ • health              │  │  │  │ 2. Manage contexts    │  │                     │
│   │  │ • metrics             │  │  │  │ 3. Cleanup stale      │  │                     │
│   │  │ • config              │  │  │  │                       │  │                     │
│   │  │ • shutdown            │  │  │  └───────────────────────┘  │                     │
│   │  └───────────────────────┘  │                             │                     │
│   └─────────────────────────────┘                             │                     │
│                                                               │                     │
└───────────────────────────────────────────────────────────────┼─────────────────────┘
                                                                │
                                                                ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    PROCESSOR LAYER                                      │
│                                                                                         │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐                     │
│   │       Agent Loop            │  │    AgentIntegration         │                     │
│   │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │                     │
│   │  │ Input: agent:input    │  │  │  │ Config:               │  │                     │
│   │  │                       │  │  │  │ • model: String       │  │                     │
│   │  │ Processing:           │  │  │  │ • max_context: usize  │  │                     │
│   │  │ 1. Context assembly   │  │  │  │ • temperature: f32    │  │                     │
│   │  │ 2. LLM API call       │  │  │  │                       │  │                     │
│   │  │ 3. Response streaming │  │  │  │ Methods:              │  │                     │
│   │  │                       │  │  │  │ • start()             │  │                     │
│   │  │ Output: agent:output  │  │  │  │ • process_message()   │  │                     │
│   │  └───────────────────────┘  │  │  │ • call_agent()        │  │                     │
│   │                             │  │  └───────────────────────┘  │                     │
│   └─────────────────────────────┘  └─────────────────────────────┘                     │
│                                                                                         │
│   ┌─────────────────────────────┐  ┌─────────────────────────────┐                     │
│   │   Command Processor         │  │   System Processor          │                     │
│   │  ┌───────────────────────┐  │  │  ┌───────────────────────┐  │                     │
│   │  │ Registry: HashMap     │  │  │  │ Registry: HashMap     │  │                     │
│   │  │   <cmd, executor>     │  │  │  │   <action, handler>   │  │                     │
│   │  └───────────────────────┘  │  │  └───────────────────────┘  │                     │
│   └─────────────────────────────┘  └─────────────────────────────┘                     │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════════
                                    消息生命周期示例
═══════════════════════════════════════════════════════════════════════════════════════════

  阶段 1: 客户端发送聊天消息
  ┌─────────┐                    ┌─────────┐                    ┌─────────┐
  │ Client  │───WebSocket/JSON──►│ Gateway │───publish()───────►│   Bus   │
  │         │  {type:"chat",     │         │  topic:            │         │
  │         │   content:"Hi"}    │         │  "gateway:input"   │         │
  └─────────┘                    └─────────┘                    └────┬────┘
                                                                     │
  阶段 2: 路由器分发到处理器                                          │
                                                                     ▼
  ┌─────────┐  route()   ┌─────────┐  handle()   ┌─────────┐   ┌─────────┐
  │  Router │◄───────────│   Bus   │────────────►│  Chat   │   │   Bus   │
  │         │            │         │             │ Handler │──►│         │
  └────┬────┘            └─────────┘             └─────────┘   │         │
       │                                                         │         │
       │                                                    publish()
       │                                                   topic:
       │                                                   "agent:input"
       │                                                         │
  阶段 3: Agent 处理并返回                                        ▼
                                                                  │
  ┌─────────┐  publish()   ┌─────────┐  process()   ┌─────────┐   │
  │   Bus   │◄─────────────│  Agent  │◄─────────────│   Bus   │───┘
  │         │  topic:      │  Loop   │              │         │
  │         │  "agent:      │         │              │         │
  │         │   output"     │         │              │         │
  └────┬────┘              └─────────┘              └─────────┘
       │
  阶段 4: 响应返回给客户端
       │
       ▼
  ┌─────────┐  route()   ┌─────────┐  WebSocket   ┌─────────┐
  │  Router │◄───────────│   Bus   │─────────────►│  Client │
  │         │            │         │  JSON        │         │
  │         │            │         │  {type:      │         │
  │         │            │         │   "response",│         │
  │         │            │         │   content:   │         │
  │         │            │         │   "Hello!"}  │         │
  └─────────┘            └─────────┘              └─────────┘


═══════════════════════════════════════════════════════════════════════════════════════════
                                      代码示例
═══════════════════════════════════════════════════════════════════════════════════════════

// 1. 创建消息总线
let bus = Arc::new(MessageBus::new());

// 2. 发布消息
let msg = Message::chat("session-1", "client-1", "Hello!");
bus.publish(Topics::gateway_input(), msg).await?;

// 3. 订阅主题
let mut rx = bus.subscribe(Topics::agent_output());
while let Some(msg) = rx.recv().await {
    println!("Received: {:?}", msg);
}

// 4. 自定义处理器
pub struct MyHandler;

#[async_trait]
impl MessageHandler for MyHandler {
    fn name(&self) -> &str { "MyHandler" }
    
    async fn handle(&self, msg: Message, bus: &MessageBus) -> Result<Option<Message>> {
        // 处理消息...
        let response = Message::response(&msg, "Processed!");
        Ok(Some(response))
    }
    
    fn can_handle(&self, kind: &MessageKind) -> bool {
        matches!(kind, MessageKind::Chat)
    }
}